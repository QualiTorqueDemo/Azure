spec_version: 2
description: >
  Deploy a Linux Virtual Machine Scale Set (VMSS) on Azure with 
  VNet, NSG, and SSH key authentication.
labels:
  - Azure-VM
inputs:
  agent:
    type: agent
    description: "Select the Torque agent to deploy this environment"
  Azure Region:
    type: string
    description: "Azure region for deployment"
    default: "westus2"
    allowed-values:
      - northcentralus
      - swedencentral
      - francecentral
      - northeurope
      - westus
      - westus2
  VM Size:
    type: string
    description: "Azure VM size for the scale set instances"
    default: "Standard_A1_v2"
    allowed-values:
      - Standard_A1_v2
      - Standard_A2_v2
      - Standard_D2_v2
      - Standard_DS1_v2
  Instances:
    type: string
    description: "Number of VM instances in the scale set"
    default: "2"
    allowed-values:
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"

outputs:
  Linux VM VMSS ID:
    value: '{{ .grains.vmss.outputs.linux_vm_vmss_id }}'
    quick: true
  Instance Private IPs:
    value: '{{ .grains.vmss.outputs.instance_private_ips }}'
    quick: true

grains:
  vmss:
    kind: terraform
    spec:
      auto-approve: false
      source:
        store: Azure
        path: assets/vmss
      agent:
        name: '{{ .inputs.agent }}'
      inputs:
        - location: '{{ .inputs.["Azure Region"] }}'
        - size: '{{ .inputs.["VM Size"] }}'
        - instances: '{{ .inputs.Instances }}'
      outputs:
        - linux_vm_vmss_id
