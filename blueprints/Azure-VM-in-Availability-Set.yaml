spec_version: 2
description: >
  Deploy Virtual Machines in an availability set on Azure, including 
  a Linux (Ubuntu) and Windows VM with disk encryption, VNet, NSG, 
  and boot diagnostics.
metadata:
  blueprint-labels:
    - key: hypervisor
      value: Azure

inputs:
  agent:
    type: string
    description: "Select the Torque agent to deploy this environment"
    default: "aks-prod"
    allowed-values:
      - aks-prod
      - aks-dev-temp
  Azure Location:
    type: string
    description: "Azure location for deployment"
    default: "westus2"
    allowed-values:
      - northcentralus
      - swedencentral
      - francecentral
      - northeurope
      - westus
      - westus2
  VM Size:
    type: string
    description: "Azure VM size"
    default: "Standard_A1_v2"
    allowed-values:
      - Standard_A1_v2
      - Standard_A2_v2
      - Standard_D2_v2
      - Standard_DS1_v2

outputs:
  Linux VM ID:
    value: '{{ .grains.vm-availability-set.outputs.linux_vm_id }}'
    quick: true
  Windows VM ID:
    value: '{{ .grains.vm-availability-set.outputs.windows_vm_id }}'

grains:
  vm-availability-set:
    kind: terraform
    spec:
      source:
        store: Azure
        path: assets/vm-availability-set
      agent:
        name: '{{ .inputs.agent }}'
      inputs:
        - location: '{{ .inputs.["Azure Location"] }}'
        - size: '{{ .inputs.["VM Size"] }}'
      outputs:
        - linux_vm_id
        - windows_vm_id
        - linux_public_ip
        - windows_public_ip
