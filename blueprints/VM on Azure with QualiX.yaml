spec_version: 2
description: Deploy an Azure Windows 2016 VM using TF accessible only via Bastion Host deployed via Helm
instructions:
  source:
    store: Azure
    path: instructions/VM_Azure_QualiX.md
inputs:
  VM Name:
    type: string
    default: MyVM
outputs:
  VM Identifier:
    value: '{{.grains.Virtual_Machine.outputs.vm_id}}'
    quick: false
  Public IP:
    value: '{{.grains.Virtual_Machine.outputs.public_ip}}'
    quick: false
  RDP Link:
    value: '{{.grains.Virtual_Machine.outputs.vm_rdp_link}}'
    quick: true
  RDP Readonly Link:
    value: '{{.grains.Virtual_Machine.outputs.vm_rdp_readonly_link}}'
    quick: true
grains:
  helm-qualix:
    kind: helm
    spec:
      source:
        store: Azure
        path: assets/helm/helm-qualix
      namespace: '{{ .params.default_aks_host_namespace }}'
      agent:
        name: '{{ .params.default_aks_host }}'
        service-account: default
      inputs:
      - sandbox_id: '{{ sandboxid | downcase }}'
      - namespace: '{{ .params.default_aks_host_namespace }}'
      # The environment variables declared in this section will be available during the grain deployment as well as the grain destroy phase
      env-vars: []
      scripts:
        post-helm-install:
          source:
            store: Azure
            path:  assets/scripts/get-qualix-external-ip_helm.sh
          outputs:
            - qualix_ip
            - qualix_hostname
            - qualix_outbound_ip
  Env_Infrastructure:
    kind: terraform
    depends-on: helm-qualix
    spec:
      source:
        store: Azure
        path: assets/terraform/azure/env_infra
      agent:
        name: '{{ .params.default_aks_host }}'
      inputs:
        - source_cidr: '{{.grains.helm-qualix.scripts.post-helm-install.outputs.qualix_outbound_ip | strip_newlines}}/32'
        - env_id: '{{ sandboxid | downcase }}'
        - location: westus2
        - env_start_address: 10.0.0.0
      outputs:
      - rg_name
      - vnet_name
      - subnet_id
  Virtual_Machine:
    kind: terraform
    depends-on: helm-qualix, Env_Infrastructure
    spec:
      source:
        store: Azure
        path: assets/terraform/azure/vm-qualix
      agent:
        name: '{{ .params.default_aks_host }}'
      inputs:
        - env_details: '{ "rg_name":   "{{.grains.Env_Infrastructure.outputs.rg_name}}", 
                          "vnet_name": "{{.grains.Env_Infrastructure.outputs.vnet_name}}",
                          "subnet_id": "{{.grains.Env_Infrastructure.outputs.subnet_id}}",
                          "env_id":    "{{ sandboxid | downcase }}"
                        }'        
        - vm_name:   '{{ .inputs.["VM Name"] }}'
        - qualix_ip: '{{.grains.helm-qualix.scripts.post-helm-install.outputs.qualix_ip}}'
        - source_snapshot_details: '{ "snapshot_name": "WinServer2022_Clean", 
                                      "snapshot_type": "Windows",
                                      "snapshot_rg": "Torque-Demo-Production",
                                      "snapshot_username": "quali-user",
                                      "snapshot_password": "Azure@Quali1"  
                                    }'        
      outputs:
      - vm_rdp_link
      - vm_rdp_readonly_link
      - public_ip
      - vm_id
      - qualix_ip
    # The terraform version that will be used to deploy the module
    tf-version: 1.2.6